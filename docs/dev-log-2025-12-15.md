# Dev Log: 2025-12-15 - Deferred Rendering Pipeline Debug Session

## Context

Continuing work on the 5-attachment deferred rendering pipeline for Vulkan. Previous session implemented:
- model.frag specular default changed from `vec4(0.0)` to `vec4(0.04, 0.04, 0.04, 0.0)` (dielectric F0)
- deferred.frag: added SpecularBuffer (binding 4) and EmissiveBuffer (binding 5) samplers
- deferred.frag: restructured main() so emissive is applied only in ambient pass (avoids multiplication by light count)
- Renamed `lighting_vulkan.sdr` to `lighting.glsl` (industry standard extension)
- Updated includes in deferred.vert and deferred.frag

## Problem Discovery

User reported: "everything is black" in the 3D scene. HUD elements render correctly (forward path), but ship geometry shows nothing.

## Diagnostic Process

### Test 1: Position buffer visualization
Added debug output to deferred.frag:
```glsl
fragOut0 = vec4(vec3(length(position) * 0.01), 1.0);
return;
```
Result: Black screen (3D area). HUD still visible.

Interpretation: Position data is zero or near-zero.

### Test 2: Adjusted scale factor
Changed to:
```glsl
fragOut0 = vec4(abs(position) * 0.001, 1.0);
```
Result: Still black.

### Test 3: Constant red output
Changed to:
```glsl
fragOut0 = vec4(1.0, 0.0, 0.0, 1.0);
return;
```
Result: **Entire screen is solid red** (except HUD elements which render on top).

## Conclusion

The deferred lighting pass executes correctly. The shader runs on all pixels. The problem is **upstream** - the geometry pass (model.frag) is not writing position data to G-buffer attachment 2.

## Investigation Done

Verified the following are correct:
- `model.frag` declares `layout(location = 2) out vec4 outPosition;`
- `model.frag` writes `outPosition = vec4(vPosition, 1.0);` at line 72
- `model.vert` outputs `vPosition = viewPos.xyz;` at line 95
- `kGBufferCount = 5` in VulkanRenderTargets.h
- `bindDeferredGlobalDescriptors()` binds gbufferView(0-2) to bindings 0-2, depth to binding 3, gbufferView(3) to binding 4, gbufferView(4) to binding 5

The pipeline configuration appears correct. The issue is likely in the geometry pass execution - either model.frag isn't running, or the framebuffer isn't configured with all 5 attachments when rendering geometry.

## Incidental Issues

- Multiple LNK1104 errors during session (exe locked by running game)
- One flaky crash in `VulkanTextureManager::flushPendingUploads` with invalid bitmap handle - likely unrelated to shader changes, did not reproduce

## Current State

Debug shader is still active (constant red output). Need to revert before next testing session.

Files modified this session:
- `code/graphics/shaders/deferred.frag` - debug code added (needs revert)

## Next Steps

1. Revert debug code in deferred.frag
2. Add debug output to model.frag to verify it executes
3. Check VulkanRenderingSession geometry pass - verify all 5 color attachments are bound
4. Check if model rendering path actually uses model.frag (vs some other shader or path)
5. Verify vPosition isn't zero coming from vertex shader

## Key Insight

The deferred pass works. The problem is the G-buffer isn't being populated. Focus investigation on the geometry pass, not the lighting pass.
